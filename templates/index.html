<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coastline New Hire / Safety Training Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="app-shell">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <!-- Put your logo at static/cfm-logo.webp -->
        <img src="{{ url_for('static', filename='cfm-logo.webp') }}"
             alt="Coastline Family Medicine Logo">
        <div class="sidebar-title">Coastline Safety Bot</div>
        <div class="sidebar-subtitle">
          Coastline Family Medicine Safety &amp;<br>
          Compliance Training Portal
        </div>
      </div>

      <div class="sidebar-main">
        <div class="sidebar-section-title">Training</div>
        <ul class="sidebar-nav">
          <li>
            <button class="primary" onclick="quickPrompt('Start full new-hire safety training sequence.')">
              <span>Start Full Training</span>
              <span class="badge">New hire</span>
            </button>
          </li>
          <li>
            <button onclick="quickPrompt('Begin Bloodborne Pathogens module.')">
              <span>Bloodborne Pathogens</span>
              <span class="badge">BBP</span>
            </button>
          </li>
          <li>
            <button onclick="quickPrompt('Start Hazard Communication training for Coastline staff.')">
              <span>Hazard Communication</span>
              <span class="badge">HazCom</span>
            </button>
          </li>
          <li>
            <button onclick="quickPrompt('Review PPE and exposure control procedures for Coastline Family Medicine.')">
              <span>PPE &amp; Exposure Control</span>
              <span class="badge">PPE</span>
            </button>
          </li>
          <li>
            <button onclick="quickPrompt('Fire safety and emergency action plan training.')">
              <span>Fire &amp; Emergency Plan</span>
              <span class="badge">EAP</span>
            </button>
          </li>
        </ul>

        <div class="sidebar-section-title">Quick Actions</div>
        <ul class="sidebar-nav">
          <li>
            <button onclick="quickPrompt('How do I report a needlestick or blood/body fluid exposure at Coastline?')">
              <span>Report Exposure / Needlestick</span>
            </button>
          </li>
          <li>
            <button onclick="quickPrompt('Summarize emergency procedures and evacuation routes for Coastline Family Medicine.')">
              <span>Emergency Procedures</span>
            </button>
          </li>
          <li>
            <button onclick="quickPrompt('Give me a 3-minute safety refresher with key points only.')">
              <span>3-Minute Refresher</span>
            </button>
          </li>
        </ul>
      </div>

      <div class="sidebar-footer">
        <strong>Contacts</strong>
        Safety Officer: Cheyenne Yost<br>
        Supervisor: Katie McKinney<br>
        Use this portal for training questions and OSHA safety topics only.
      </div>
    </aside>

    <!-- MAIN CHAT COLUMN -->
    <main class="main">
      <header class="main-header">
        <h1 class="main-title">Coastline New Hire / Safety Training Bot</h1>
        <p class="main-subtitle">
          Complete your required OSHA safety modules or ask a Coastline safety question at any time.
        </p>

        <div class="progress-row">
          <span class="progress-label" id="progressLabel">
            New-hire training progress
          </span>
          <span class="progress-badge" id="progressBadge">
            0% complete
          </span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="pill-row" style="margin-top: 6px;">
          <button class="pill-button"
                  onclick="quickPrompt('Start full new-hire safety training sequence.')">
            Start full training
          </button>
          <button class="pill-button"
                  onclick="quickPrompt('Give me a quick overview of Coastline Family Medicine safety rules.')">
            Safety overview
          </button>
          <button class="pill-button"
                  onclick="quickPrompt('What should I do immediately after a needlestick?')">
            Needlestick steps
          </button>
        </div>
      </header>

      <div id="errorBanner" class="error-banner"></div>

      <div class="chat-messages" id="chatMessages">
        <div class="message bot system">
Hi! I’m the Coastline Family Medicine safety training bot.
You can say “Start full training” or ask a specific safety question (e.g., “How do I report a needlestick?”).
        </div>
      </div>

      <div class="status-text" id="statusText"></div>

      <div class="chat-input-area">
        <input
          type="text"
          id="userInput"
          placeholder="Type your question or say 'Start full training'..."
        />
        <button id="sendButton">
          <span>Send</span>
          <span>➤</span>
        </button>
      </div>
    </main>

    <!-- RIGHT CONTEXT PANEL -->
    <aside class="right-panel">
      <div class="right-panel-header">
        <div class="right-status">
          <span class="status-dot"></span>
          <span id="botStatusText">Bot online — training ready</span>
        </div>
        <div class="right-panel-tabs">
          Current module, key points &amp; transcript
        </div>
      </div>

      <!-- Current module card -->
      <section class="card" id="cardCurrentModule">
        <div class="card-title">Current Module</div>
        <div class="card-muted" id="currentModuleName">
          New-Hire Training Sequence
        </div>
        <p class="card-muted" id="currentModuleDescription">
          You’re beginning the full Coastline new-hire safety training,
          including BBP, HazCom, PPE, workplace violence, and emergency procedures.
        </p>
        <div class="card-pill-row">
          <span class="card-pill">BBP</span>
          <span class="card-pill">HazCom</span>
          <span class="card-pill">PPE</span>
          <span class="card-pill">EAP</span>
        </div>
      </section>

      <!-- Checklist card -->
      <section class="card" id="cardChecklist">
        <div class="card-title">Checklist for New Hires</div>
        <ul class="card-list" id="checklistItems">
          <li>Complete full new-hire safety training modules.</li>
          <li>Know how to report an exposure or incident.</li>
          <li>Know where to find Coastline policies &amp; procedures.</li>
        </ul>
      </section>

      <!-- Session snapshot card -->
      <section class="card" id="cardSnapshot">
        <div class="card-title">Session Snapshot</div>
        <p class="card-muted" id="sessionSnapshot">
          Key training messages can be summarized here later, so you can
          review what you’ve already covered in this session.
        </p>
      </section>
    </aside>
  </div>

  <script>
    const messagesDiv = document.getElementById("chatMessages");
    const userInput   = document.getElementById("userInput");
    const sendButton  = document.getElementById("sendButton");
    const statusText  = document.getElementById("statusText");
    const errorBanner = document.getElementById("errorBanner");
    const typingId    = "typing-indicator";

    const history = [];

    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.classList.add("message", sender);
      div.textContent = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTyping() {
      removeTyping();
      const wrapper = document.createElement("div");
      wrapper.classList.add("message", "bot");
      wrapper.id = typingId;

      const dots = document.createElement("div");
      dots.classList.add("typing-indicator");
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement("span");
        dot.classList.add("typing-dot");
        dots.appendChild(dot);
      }
      wrapper.appendChild(dots);
      messagesDiv.appendChild(wrapper);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function removeTyping() {
      const existing = document.getElementById(typingId);
      if (existing) existing.remove();
    }

    function setStatus(text) {
      statusText.textContent = text || "";
    }

    function showError(text) {
      if (!text) {
        errorBanner.style.display = "none";
        errorBanner.textContent = "";
      } else {
        errorBanner.style.display = "block";
        errorBanner.textContent = text;
      }
    }

    function quickPrompt(text) {
      userInput.value = text;
      sendMessage();
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      addMessage(text, "user");
      userInput.value = "";
      sendButton.disabled = true;
      setStatus("Contacting Coastline Safety Bot…");
      showError("");
      showTyping();

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, history }),
        });

        const data = await res.json();
        removeTyping();

        if (data.reply) {
          addMessage(data.reply, "bot");
          history.push({ user: text, assistant: data.reply });

          // TODO: optional: parse data.meta to update progress, right panel, etc.
          // For now we just keep UI static.
        } else if (data.error) {
          showError("Error: " + data.error);
        } else {
          showError("Unexpected response from server.");
        }
      } catch (err) {
        console.error(err);
        removeTyping();
        showError("Network error trying to reach the server.");
      } finally {
        sendButton.disabled = false;
        setStatus("");
      }
    }

    sendButton.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>



